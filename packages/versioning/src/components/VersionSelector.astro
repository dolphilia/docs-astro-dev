---
import { Button } from '@docs/ui/components';
import type { Version } from '../utils/version';

interface Props {
  versions: Version[];
  currentVersion: string;
  basePath: string;
  className?: string;
}

const { versions, currentVersion, basePath, className = '' } = Astro.props;

// 現在のバージョンオブジェクトを取得
const currentVersionObj = versions.find(v => v.id === currentVersion) || versions[0];

// バージョンリストを日付順にソート
const sortedVersions = [...versions].sort((a, b) => {
  // 最新バージョンは常に先頭
  if (a.isLatest === true && b.isLatest !== true) return -1;
  if (b.isLatest === true && a.isLatest !== true) return 1;
  
  // date プロパティの存在を確認
  const dateA = a.date ? a.date.getTime() : 0;
  const dateB = b.date ? b.date.getTime() : 0;

  // 日付の新しい順
  return dateB - dateA;
});
---

<div class:list={['dropdown', className]}>
  <div tabindex="0" role="button" class="btn btn-ghost m-1">
    <span>
      {currentVersionObj.name}
      {currentVersionObj.isLatest && (
        <span class="badge badge-sm badge-primary ml-2">最新</span>
      )}
    </span>
    <svg class="w-4 h-4 ml-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
      <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
    </svg>
  </div>
  <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
    {sortedVersions.map(version => (
      <li>
        <a 
          href={`${basePath.replace(`/${currentVersion}/`, `/${version.id}/`)}`}
          class={version.id === currentVersion ? 'active' : ''}
        >
          <div class="flex flex-col">
            <div class="flex items-center justify-between">
              <span>{version.name}</span>
              {version.isLatest && (
                <span class="badge badge-xs badge-primary">最新</span>
              )}
            </div>
            <div class="text-xs opacity-70">
              {version.date && typeof version.date.toLocaleDateString === 'function' ? version.date.toLocaleDateString() : 'N/A'}
            </div>
          </div>
        </a>
      </li>
    ))}
  </ul>
  
  <div class="mt-4 flex flex-col gap-2">
    {currentVersion !== 'latest' && (
      <a
        href={`${basePath.replace(`/${currentVersion}/`, '/latest/')}`}
        class="link link-primary link-hover text-xs"
      >
        最新バージョンを表示
      </a>
    )}
    
    <a
      href={`/docs-astro/version-diff${basePath.replace('/docs-astro', '')}`}
      class="link link-primary link-hover text-sm"
    >
      バージョン間の差分を表示
    </a>
  </div>
</div>
